# 计算机网络

## 计算机硬件

### 计算机计数（***）

##### 进制转换

1. 二进制转十进制：加权法
2. 十进制转二进制：
   1. 整数部分：短除法，不断除2取余，直到为0，然后**从下向上**排为二进制
   2. 小数部分：乘2去整，直到变为整数，然后**从上自下**取值

##### 原码、反码、补码和移码

> 符号位（最高位）始终不变，正数为 0 ，负数为 1
>
> 除去符号位为真值，真实表示该数值的二进制数

定义：

+ 原码：**真值**
+ 反码：真值**取反**
+ 补码：计算机数值一律<b style="color:red;">使用补码</b>来表示和储存
  + 正数：原码
  + 负数：<u>反码 + 1</u>，+1是为“补”
+ 移码：<u>符号位取反</u>的补码

转化：

+ 正值：原码 = 反码 = 补码
+ **负值：**
  + 原码 > 反码：取反
  + 反码 > 补码：+ 1
  + 补码 > 原码：取反 并 + 1

取值范围：注意补码比原码和反码范围大了1，因为后者的+0、-0取值不一样，而补码取值相同，所以可以多表示一位

|      |         定点整数         |
| :--: | :----------------------: |
| 原码 | -(2^(n-1)-1) ~ 2^(n-1)-1 |
| 反码 | -(2^(n-1)-1) ~ 2^(n-1)-1 |
| 补码 |   -2^(n-1) ~ 2^(n-1)-1   |

### 计算机体系结构（***）

#### CPU结构

1. 运算器：操作**“数据”**

   1. ALU：算数以及逻辑运算
   2. 累加寄存器（AC）：暂存ALU运算结果
   3. 数据缓冲寄存器：读取内存，或即将存入内存的指令与数据，暂存它们
   4. 状态条件寄存器（PSW）：保存运算中的状态标志，如溢出、进位

2. 控制器：操作**“指令”**

   1. 程序计数器（PC）：每次读取下一条指令地址， 至2

   2. 指令寄存器（IR）：获取当前指令，获取操作码到3

   3. 指令译码器：译码并产生操作信号，至**运算器**

   4. 时序部件

      > 指令被读取时，数据缓冲寄存器 => 指令寄存器

3. 总线：实现部件连接

   1. 数据总线（DB）：传输数据；其宽度（单位：bit），决定一次传输的二进制位数
   2. 地址总线（AB）：传输地址；其宽度，决定CPU寻址内存空间大小
   3. 控制总线（CB）

#### 指令系统

> 操作数：待操作数据；地址码：寻找操作数；操作码：对操作数进行的操作

1. 寻址方式：因为操作数可以存放在很多地方，导致寻址方式有多种；不同寻址方式可以**扩大寻址空间**

   1. 立即寻址：地址码中放操作数，**不需要存储**，缺点是容量小
   2. 内存寻址：数据存放在**内存中**
      1. 直接寻址：地址码 => 内存（数据）
      2. 间接寻址：地址码 => 内存（地址码）=> 内存（数据）
      3. 变址寻址：地址码 + 变址寄存器
   3. 寄存器寻址：存放在**寄存器中**，类上条
      1. 寄存器直接寻址
      2. 寄存器间接寻址

2. RISC 与 CISC


| 指令系统类形       | 指令               | 寻址方式 | 实现方式       |
| ------------------ | ------------------ | -------- | -------------- |
| CISC （复杂）      | 种类多，可变长格式 | 多       | 微程序控制技术 |
| RISC（精简）- 高效 | 种类少，定长格式   | 少       | 硬布线逻辑控制 |

3. Flynn

   1. 单指令流、单数据流：SISD

   2. 单指令流、多数据流：SIMD

   3. ~~多指令流、单数据流~~：MISD，不存在！

   4. 多指令流、多数据流：MIMD 

   5. > instruct/ɪnˈstrʌkt/：n.指令；multiple/ˈmʌltɪpl/：adj.多个的

4. 流水线

   1. 流水线：多条指令重叠进行操作
   
   2. 流水线指令执行时间：
      $$
      T = 第一条指令执行所需时间 + （指令条数 - 1 ）*流水线周期
      $$
      流水线周期：指令执行阶段中**执行时间最长的一段时间**
   
   3. 流水线技术指标
   
      1. 吞吐量：单位时间内，流水线可以处理的指令条数；理论最大为1/流水线周期（）
      2. 加速比：流水线使用前后的时间之比

#### 存储系统（***）

1. 存储设备：
   1. 多级层次存储器：自上往下：存取速度↓；成本↓；容量↑
      1. CPU（寄存器）
      2. 缓存：cache 高速缓存器，实现缓和CPU和主存之间的速率矛盾
      3. 主存（普通内存）：
      4. RAM：随机存储器，可读可写，掉电丢失；分为静动态
         1. DRAM：动态RAM，需要电路动态刷新，常用于内存
         2. SRAM：静态RAM，不需要电路动态刷新，常用于 Cache
      5. ROM：只读存储器，掉电不丢失
      6. 辅存（本地磁盘）
   2. 交互：
      1. 缓存-主存层次：辅助硬件
      2. 主存-辅存层次：辅助软（如虚拟内存）、硬件 
2. 存储方式：依次变快
   1. 顺序存取（磁带）
   2. 直接存取（硬盘）：所有地址共享读写装置，可以直接移动到地址获取内容，因此**访问时间与数据所在位置有关**
   3. 随机存取（内存）：每个地址都有唯一地址和唯一读写装置，任何地址**访问时间都相同**
   4. 相联存取（Cache）：Cache中有按内容寻址的相联存储器，将接下来可能会用到的**内容直接存入**
3. 存储计算
   1. 主存储器中，使用word（字）做单位，每个字一个地址
   2. 相关术语：
      1. 位：bit，每个二进制为1bit
      2. 字节：B，**1B = 8bit**
      3. 字：CPU 一次处理的二进制位数，通常为<u>字节的整数倍</u>；对应字长有：8/16/32/64 bit
4. RAID 技术：将同一阵列的多个磁盘视为单一虚拟磁盘，数据以分段方式存放于序列中
   1. RAID 1.0：传统版本
      1. RAID 0：使用数据分段技术（条带化），所有硬盘构成阵列，<u>利用率100%</u>
         1. 使用效率最佳
         2. 写入速度快
         3. 可靠性最差
      2. RAID 1：使用硬盘镜像技术，一半用来保存一般用来备份，<u>利用率50%</u>
         1. 使用效率不高
         2. 可靠性高
      3. RAID 3：特定盘奇偶校验的数据分段技术，<u>利用率（n-1）/n</u>
      4. RAID 5：分布式奇偶校验的数据分段技术，<u>利用率（n-1）/n</u>
         1. 与3的不同在于，校验值不放在特定的一个盘中，而分布于每个盘的部分位置，可以**分散负载**，提高性能
      5. RAID 6：带有两个独立分布式校验方案的独立数据磁盘，<u>利用率（n-2）/n</u>
      6. **RAID 10**：实际上是先做 RAID 1（镜像），再做 RAID 0（条带化）
   2. RAID 2.0 的优势
      1. 快速重构
      2. 自动负载均衡
      3. 系统性能提升
      4. 自愈合

#### 系统可靠性（**）

1. 失效率：串联、并联系统
2. 平均无故障时长
3. 平均故障修复时长
4. 可用性

## 第2章 操作系统

### 进程管理（***）

#### 进程状态

+ 运行态：进程占有处理器，在运行
+ 就绪态：进程具备运行条件，等待系统分配处理器
+ 等待态/阻塞态：进程不具备运行条件，正在等待某事件的完成

#### 进程死锁

##### 死锁条件

如下4个条件**同时**成立

1. 互斥：至少一个资源处于非共享模式
2. 占有和等待：多个进程的情况下，一个进程应至少占有一个资源，并等待另一个资源；但该资源被其他进程所占有
3. 非抢占：资源是非抢占的，一个资源只能被动等待进程释放
4. 循环等待：一组等待进程，互相占有其他进程等待的资源，并等待其他进程占有的资源

##### 死锁的解决

+ 死锁预防：要求用户申请资源时，一次性申请所有资源，破坏*条件2*
+ 死锁避免：进程申请资源时，判断操作是否安全，但会增加开销；
  + 典型算法：银行家算法
+ 死锁检测：判断当前是否陷入死锁，若是则执行下一步死锁解除
+ 死锁解除：与上一条结合使用，强制**剥夺**某进程所占用的资源

永远不会死锁的最少同类资源数：
$$
K=N*(R-1)+1
$$

##### 进程同步与异步

1. 同步：B进程需要A进程的完成，才能开始，是直接制约关系
2. 互斥：A进程使用了临界资源，导致B进程必须等待（被阻塞），是间接制约关系

---

+ 信号量 S：计数器；值仅能通过 PV 操作来改变，通过控制信号量来实现进程的同步或异步
+ PV 操作：
  + P 操作：S=S-1， 若 S >= 0，该进程继续执行，否则进入等待队列；
    + 申请资源，但不一定申请得到；如 S  - 1 < 0 后，进程便进入等待
  + V 操作：S=S+1，若 S <= 0，唤醒等待中的一个进程；
    + 释放资源/上传资源

> 在互斥关系中，PV操作在**一个进程中**成对出现
>
> 在同步关系中，PV操作在**两个或多个进程中**成对出现

#### 存储管理（*）

##### 页式存储

将内存划分为若干相同大小的页，便于将进程拆分为任意页，放置于任意位置，提高利用率

从逻辑地址到物理地址的换算：

1. 逻辑地址包括：逻辑页号与页内地址
2. 另外有从 逻辑页号到物理页号 的映射
3. 映射到的 物理页码 + 页内地址（直接拼接即可，不必计算）

---

如何计算**页号占有的位数**：总地址位数 - 页面大小所占位数

例：已知逻辑地址 2D16H，页大小 4kb 

则：地址共 4 * 4 = 16位，页大小 4kb = 4 * 1024b = 2^12 => 占12位，故：页号占位 4 位

##### 页面置换算法

程序的存储空间大于实际内存时，使用虚拟存储技术，每次只放入运行需要的页；当新加入的页没有位置放时，执行**页面置换**，淘汰已有页，加入所需页

其算法包括：

+ 先进先出（FIFO）：队列方式
+ 最佳置换法（OPT）：淘汰页应该在之后不被使用，或在最长的时间后才被使用
+ 最近最少使用置换法（LRU）：淘汰最近一段时间内，最后没有被使用的页

#### 文件管理（**）

DOS 系统、UNIX 系统、Windows 系统都采用**多级树形目录结构**

每级目录包含两个目录：`.`表示目录自身，`..`表示其上级目录

绝对路径：从**根目录**开始到文件的路径，又称作完全路径，始终确定不变

相对路径：从**用户当前工作目录**开始到文件的路径，会随着用户目录变化而变化

#### 设备管理（** ）

管理外部设备（I/O设备） ，其有三个任务：

+ 数据传输操作
+ 数据交换操作
+ 对用户友好的透明接口，不必让用户与设备直接对接

##### 数据传输控制方式

分为五种：

+ 程序查询：CPU 不断检测 I/O设备是否就绪，两者处于串行工作，会占用很长时间
+ 程序中断：I/O设备 主动请求中断 CPU；但以字节为单位中断，所以依然会占用很长时间
+ DMA（直接存储）： DMA控制器 向 CPU 请求总线控制权，之后可以不经过 CPU ，直接在内存与 I/O设备 之间进行；*但 CPU 仍然需要控制 I/O设备。*
+ I/O 通道控制：代替 CPU 管理控制 I/O设备的独立部件；I/O通道 与 CPU 分时使用主存，可以实现两者的**并行工作**
+ I/O 处理机：不但有 I/O控制，还包括更多功能，通常**独立于主机工作**，可以设置多台

注：单片机、微型机多采用前三者；大中型计算机使用后两者

## 第三章 系统开发和项目管理

### 软件生命周期

+ 计划阶段
  + 问题定义
  + 可行性分析
+ 需求分析阶段
+ 总体设计阶段
+ 详细设计阶段
+ 编码阶段
+ 测试阶段
+ 维护阶段

### 软件开发模型

+ 瀑布模型：需求确定，之前具有相似经验
+ V 模型
+  原型化模型
  + 抛弃型模型
  + 演化模型
  + 增量模型
+ 喷泉模型
+ 螺旋模型

### 软件测试

划分模块时，应做到**高内聚，低耦合** 

+ 静态测试：不运行软件，静态检查文档与代码；也可以实现白盒测试
+ 动态测试：运行软件
  + 黑盒测试：功能测试
  + 白盒测试：逻辑驱动测试、路径测试、结构测试
  + 灰盒测试：介于黑白盒测试之间

#### 测试分类

根据目的、阶段的不同，划分为：

1. 单元测试
2. 集成测试
3. 确认测试
4. 系统测试
5. 验收测试

+ 回归测试：其他阶段测试出的问题解决后，再次测试修改是否会造成其他问题

#### 进度管理

##### 甘特图（Gantt图）

使用水平线段，表示计划的任务起始时间，其长度表示用时

+ 优点：能反映项目进度
+ 缺点：不能反映项目依赖关系

##### 计划评审图（PERT图）

使用网络图，描述各个任务的关系

+ 优点：能反映项目依赖关系
+ 缺点：不能清晰反映项目并行关系

> 关键路径：用时最长的路径，可能有数条
>
> 关键事件：关键路径上的任务
>
> 工程工期：关键路径总用时
>
> 松弛时间：不影响工期，可以推迟的最大时间；关键路径上的任务松弛时间为 0

## 第四章 知识产权

### 著作权（版权）

#### 保护期限

+ 个人
  + 署名权、修改权、保护作品完整权：**无限**
  + 发表权、使用权、获得报酬权：作者**终身及其50年**
+ 单位
  + 发表权、使用权、获得报酬权：**首次发表后的50年**

#### 著作权人的确认

著作权属于**作者**

+ 创作作品的公民是作者
+ 由法人或其他组织主持，代表法人或其他组织意志创作，并由法人或其他组织承担责任的作品，法人或其他组织视为作者

> **国家版税局**主管软件著作权登记

### 商标权

有效期：10年，期满前12个月内可续展，次数无限，每次10年

归属：

+ 先申请者
+ 同时申请，先使用者
+ 无证据，协商，否则再抓阄

### 专利权

一定期限内依法享有的独占实施权

归属：先申请者，否则协商：

+ 作为共同申请人
+ 一方放弃，另一方赔偿

*同一个发明只授予一个专利权*

## 第五章 数据通信技术

### 模型

#### 通信术语

+ 信息
+ 数据
+ 信号
  + 模拟信号：连续变化的物理量（如电压）
  + 数字信号：离散值
+ 码元：信号的基本单位

#### 通信系统

+ 源系统
  + 源点（DTE）
  + 发送器（DCE）：调制/解调器

+ 传输系统：系统的不同，决定信号的不同

+ 目的系统
  + 接收器
  + 终点

#### 信道特

计算码最高的传输速率

##### 奈奎斯特定理： 理想情况下的结果

带宽W，单位Hz；对于模拟信号来说：W = 最高频率 - 最低频率

码元速度B-波特(baud)；数据速率R(bps)；码元类型数N

+ B = 2W
+ R = B*log2(N)

码元类型越多，单位码元所携带的比特就越多

##### 香农公式：存在高斯噪音的情况

信噪比SNR，单位为分贝dB；

信号平均功率S；高斯噪音功率N； 

极限数据速率C(bps)

+ 计算S/N：SNR = 10*log10(S/N) => S/N = 10^(SNR/10)

+ 香农公式：C = W*log2(1+S/N)

#### 调制技术

模拟信道传送数字数据

| 调制技术    | 说明                   | 码元种类 | 比特位 | 特点                         |
| ----------- | ---------------------- | -------- | ------ | ---------------------------- |
| ASK（调幅） | 是否有载波             | 2        | 1      | 实现简单，抗干扰性差，效率低 |
| FSK（调频） | 载波频率不同           | 2        | 1      | 抗干扰性较强，但占用带宽较大 |
| PSK（调相） | 载波初始相位（0、180） | 2        | 1      | 起始0度，每180度为一种状态   |
| 2DPSK       | 相对调相               | 2        | 1      | 前后码元的初始相位是否变化   |
| 4DPSK       | 四差分相移键控         | 4        | 2      | 起始0度，每90度为一种状态    |
| QPSK        | 正交相移键控           | 4        | 2      | 起始45度，每90度为一种状态   |
| MQAM        | 正交幅度键控           |          |        |                              |

#### 编码技术

数字信道传送模拟数据

PCM脉冲编码调制技术

+ 采样：奈奎斯特采样定律-采样频率应该大于模拟信号的最高频率的**2倍**
+ 量化：分类为离散值（码元类型数）
+ 编码 

#### 数字编码

+ 极性编码：
  + 单极性码
  + 极性码
  + 双极性码
+ 归零码
+ 不归零码
+ 双相码
+ 曼彻斯特编码：效率只有50%
  + 曼彻斯特编码：
    + 从高到低 与 从低到高
    + 用于10M以太网
  + 差分曼彻斯特编码 ：
    + 比较相邻载波的前沿是否变化：有-1；无-0
    + 用于令牌环网

| 编码方案 | 说明                | 效率              | 典型应用                     |
| -------- | ------------------- | ----------------- | ---------------------------- |
| 4B/5B    | 4位数据 => 5位符号  | 1.25波特/位(80%)  | 100Base-FX、100Base-TX、FDDI |
| 8B/10B   | 8位数据 => 10位符号 | 1.25波特/位(80%)  | 千兆以太网                   |
| 8B/6T    | 8bit => 6个三进制数 | 0.75波特/位(133%) | 100Base-T4                   |

#### 复用技术

##### 复用技术

+ 空分复用（SDM）：空间，光缆
+ 频分复用（FDM）：频率，广播
+ 时分复用（TDM）：时间
  + 同步时分：在被分配的时间片内，即使用户无需传输，也占用该时间片
  + 异步/统计时分：智能分配给需要的用户
+ 波分复用（WDM）
+ 码分复用（CDMA）

##### 复用标准

| 名称     | 原理与组成                                                   | 应用地区   |
| -------- | ------------------------------------------------------------ | ---------- |
| E1载波   | 同步时分复用，包括30个话音信道 + 2个控制信道-<u>CH0与CH16</u>，所有信道容量都是64k，复合为2.048Mbps信道（32*64k） | 欧洲       |
| E2       | 8.488Mbps，相当于4E1                                         |            |
| E3       | 34.368Mbps，相当于4E2                                        |            |
| E4       | 139.264Mbps，相当于4E3                                       |            |
| T1载波   | 同步时分复用，包括24个话音信道，复合为1.544Mbps信道          | 美国与日本 |
| T2(DS2)  | 6.312Mbps，由4个T1时分复用构成                               |            |
| T3(DS3B) | 44.735Mbps，由7个T2时分复用构成                              |            |
| T4(DS4B) | 274.176Mbps，由6个T3时分复用构成                             |            |

+ 每帧传送
  + E1载波：32* 8bit = 256bit
  + T1载波：24* 8bit + 1bit= 193bit（1bit 用于控制）
+ 每帧耗时：**125μs**，是固定值

#### 通信方式

设备传输方式

+ 单工
+ 半双工
+ 全双工

同/异步：

+ 同步：数据块为单位，需要先建立同步传输，效率更高开销更小
+ 异步：字符为单位，需要增加额外开销，表示起始结束

并/串行

+ 并行：一次同时传输多位，计算机内部传输
+ 串行：一次同时传输一位，适用于有距离的传输（路由器到路由器）

#### 差错控制

##### 码距

+ 简单说法：两个合法码字间，不同的二进制位数总和
  + 1101 - 1011 => 2位
  + 1000 - 0101 => 3位
+ 定义：整个编码系统中任意两个合法码字的最小距离

##### 码距与检错、纠错

1. 一个码组中，为了检测e个误码，要求最小码距 d >= e+1
2. 一个码组中，为了纠正t个误码，要求最小码距 d >= 2t+1

##### 校验方式 

###### 奇偶校验

增加1位为校验位，使得 数据各位+校验位异或计算

+ 等于 0：偶校验
+ 等于1：奇校验

###### 海明校验

$$
m+k+1<=2^k
$$

 m = 数据位数；k = 冗余位数；计算时，依次带入1、2、…n，求得k的最小值 

注意

+ 海明码并非接在数据码前后，而是依次插入在**2的幂次位上**（1、2、4、8…）
+ 海明码既可以查错，又可以纠错

###### CRC校验

增加校验码

+ 基于CRC生成多项式，例如`x^4+x^3+x+1`
+ 原始报文增加若干个0，个数为校验位的个数，也即多项式的最高幂数（此处是4）；作为被除数
+ 多项式转化为二进制数：如`11011`
+ 进行模2除法，即循环异或，得到商为校验码（4位）
+ 原始报文之后增加校验码

校验：

+ 信息码（原始+校验码）除以多项式二进制，能<u>整除则无错误</u>
+ 一般CRC只检查错误，有错误时请求重发

## 第六章 网络体系结构

### 网络基本概念

计算机网络概念

#### 性能

1. 速率
2. 带宽
   1. 数字：bps（位每秒）
   2. 模拟：Hz
3. 吞吐率
4. 时延
   1. 发送时延 = 数据帧长度 / min(信道带宽, 速率)
   2. 传播时延 = 信道时延 / 电磁波在信道上的传播速率  
      1. 电缆中的速率：**200m/μs**
      2. 卫星信号的传播延迟：**270ms**
   3. 处理时延
   4. 排队时延
5. 往返时间
6. 利用率

#### 网络协议

为进行网络数据交换而制定的规则、约定与标准称为网络协议，包括：

+ 语义：协调与差错处理的控制信息
+ 语法：数据、控制信息的格式、编码与信号电平
+ 时序：速度匹配与排序

### OSI七层结构

体系结构定义了七层模型，从上往下为：

1. 应用层：简化五层模型中，与表示层、会话层合并为应用层
2. 表示层
3. 会话层
4. 传输层：传输**段**，实现端到端的映射（端口号），实现包的分段与重组
5. 网络层：传输**包**，进行路由的选择与中继（IP数据包）
6. 数据链路层：传输**帧**，提供差错校验与恢复（）
7. 物理层：传输**比特流**，提供物理通道，任意的比特流都可以转化成实际的电路信号

#### 数据-封装与解封装

+ 封装：发送方，将要传输的数据，由应用层从上至下<u>封装为负载</u>
+ 解封装：接收方：将接收到的负载，由物理层从下至上<u>解封装为数据</u>

#### 服务访问点

OSI模型中，N实体为(N+1)实体提供服务，(N+1)实体对N实体请求服务

上述操作由**服务访问点（SPA）**实现

并将N实体称为N服务提供者，(N+1)实体称为N服务用户

##### 各个层的SPA：

+ 数据链路层：LLC地址
+ 网络层：IP地址
+ 传输层：端口号

### TCP/IP 体系结构

分为四层，每层包含了一个或多个OSI模型层

1. 应用层：对应 应用层 + 表示层 + 会话层
2. 传输层：对应 传输层
3. 网络互连层：对应 网络层
4. 网络接口层：对应 数据链路层 + 物理层

#### 网络接口层

提供IP数据包的发送与接收功能

#### 网络互连层

提供计算机间的分组传输；包含：

+ <u>IP协议</u>：提供统一的地址格式和 IP数据包格式，消除各通信子网的差异

#### 传输层

提供应用程序间的通信功能；包含 <u>TCP与UDP</u>： 

+ TCP提供面向连接的，可靠的字节流传输
+ UDP提供无连接的，不可靠的数据包传输

#### 应用层

提供常用的应用程序；包含应用层协议：

+ 基于TCP：HTTP、FTP、SMTP、POP3、Telnet
+ 基于UDP：DNS、SNMP、RIP、DHCP

## 第七章 局域网技术

计算机网络按照覆盖范围，分为：局域网（LAN）、城域网（MAN）、广域网（WAN）

### 局域网定义

<u>有限区域内</u>的多台计算机互连形成的计算机组

#### 拓扑结构

+ 星形拓扑
+ 总线拓扑
+ 环形拓扑
+ 网状拓扑

### IEEE 802标准

局域网只是短距离传输，所以不涉及网络层及以上

模型只考虑最低两层，而其中将数据链路层分为两层

1. 数据链路层
   1. 逻辑链路控制层（LLC）：向上，提供服务访问点，建立数据通信连接，并具备寻址、差错控制、顺序控制和流量控制等功能
      1. 无确认无连接服务：数据包类型；速度最快，不保证可靠性
      2. 面向连接方服务：需要建立连接，提供差错控制与流控；速度慢，可靠
      3. 有确认无连接服务：提供数据报确认功能，但不建立连接；折衷方案
   2. 介质访问控制层（MAC）：向下，管理通信实体接入信道并建立链路的过程
      1. 控制各种介质访问控制技术的特征
         1. 循环式：每个站轮流得到发送机会；令牌环网、令牌总线网、FDDI
         2. 预约式：使用时间划分为时间槽；如DQDB
         3. **竞争式**：如 CSMA/CD
2. 物理层

### 以太网技术 - CSMA/CD 协议

共享型以太网的核心技术是**带冲突检测的载波监听多路访问**（CSMA/CD）协议，是竞争型协议

#### CSMA：载波监听

1. 非坚持监听算法：遇到忙线时，随机后退一段时间，再次监听，直到空闲时立即发送；利用率不高
2. 1-坚持型监听算法：持续监听直到空闲，立即（100%概率）发送；会增大冲突的概率
3. P-坚持型监听算法：持续监听直到空闲，以P%概率发送；折衷，但复杂

#### CD：冲突检测

采用**边听边发**的冲突检测方式，检测冲突所需的最长时间（争用期/碰撞窗口）为网络传播时延的2倍
$$
最小帧长度（bit）/数据传输速率（bps）>=2*两点间最长距离（m）/信号传播速率（200m/μs）
$$

#### 冲突处理

立即停止发送、并随即延迟重发，算法：

1. 确定基本退避时间，一般为**争用期** = *2t*（t为传播时延）
2. 从整数集合{0, 1…2^k-1}中，随机选取一个数 r（k为重发次数），再令 **r=min{r, 10}**
3. 延迟重发时间为：r倍的2t
4. 当 k = 16时，丢弃该数据帧，并向高层报告

#### MAC 地址

表示网络设备的标识码，唯一；长 6B = 48bit ，通常写为<u>12个十六进制数，每6个分为一组</u>：

+ 前6组（24比特）为供应商标识
  + 第1组的最低位（第8比特），用于区分目的地址：
    + 0-单播地址（物理地址）：为单独设备
    + 1-组播地址（逻辑地址）：为一组设备
      + 组播地址：范围为`0100.5E00.0000~0100.5E07.FFFF`
      + 广播地址：固定为`FFFF.FFFF.FFFF`，全为 1
+ 后6组为供应商对网卡的唯一编号

#### 以太帧结构

以太帧结构如下（以字节为单位）：

+ 前导字段（7）：接收时，快速同步发送端时钟频率
+ 帧起始符（1）：固定为`10101011`，提示MAC帧即将到来
+ 目的地址 & 源地址（2或6）：双方的MAC地址
+ 长度/类型（2）：有两种不同的定义
  + 以太网v2标准：定义为类型
  + IEEE 802.3标准：定义为数据字段的长度
  + 区分：该值<u>大于1536（0x0600）</u>为协议，否则为数据字段长度；市面上大部分为<u>以太网 v2协议</u>
+ 数据字段 & 填充字段（46~1500（0~46））
  + 整个以太帧最小为64B，除去其他固定部分，数据字段应该**最小为46B**
  + 当数据不足时，增加填充字段
+ 校验和（4）：使用**CRC校验**用到的校验值

无效以太帧：

1. 长度不在正常范围内：小于64（46+18）B，或大于1518B（1500 + 18）（其他固定部分长18B）
2. 校验不通过
3. 比特数不为字节的整数倍

#### 冲突域与广播域

冲突域（共享段）：

+ 同一物理网段上的所有网络节点，互相竞争带宽
+ 属于OSI第一层（物理层）的概念，可以被二层及以上设备分割
  + 不能分割：集线器（物理层）
  + 能分割：交换机（链路层）、路由器（网络层）
+ <u>交换机的每一个接口都是一个独立的冲突域</u>

广播域：

+ 接收同样广播消息的节点集合
+ 属于OSI第二层（数据链路层）的概念，可以被三层及以上设备分割
  + 不能分割：集线器（物理层）、交换机（链路层）
  + 能分割：路由器（网络层）
+ <u>路由器的每一个接口都是一个独立的广播域</u>

#### 网络传输介质

##### 类型

+ 电缆（双绞线）：传输范围为**100m**

  + 无屏蔽双绞线（UTP）
    + 三类UTP：电话线，用于10M网络（Cat.3）
    + 五类UTP：网线，用于100M网络（Cat.5）
    + 超五类、六类UTP：用于1000M网络（Cat.5e、Cat.6）

  + 屏蔽双绞线（STP）：用于保密性比较高的场合

  + 同轴电缆：用于有线电视

+ 光纤：原理为光信号的全反射，传输范围**500~2000m**
  + 多模光纤：
    + 直径大，损耗大
    + 适用于中短距离
    + 光源：LED，成本更低
  + 单模光纤：
    + 直径小，损耗小
    + 适用于长距离
    + 光源：激光，成本更高

##### 网线标准

下划线为实际使用的管脚，其他为备用：

+ T568A：<u>白绿、绿、白橙</u>、蓝、白蓝、<u>橙</u>、白棕、棕
+ T568B：<u>白橙、橙、白绿</u>、蓝、白蓝、<u>绿</u>、白棕、棕

直通线（不同类型的设备）：T568B - T568B

交换线（相同类型的设备）：T568A - T568B

#### 高速以太网

+ 快速以太网
  + 为了向前兼容，帧格式等都没有变，但每个比特发送时间从100ms变为10ms
  + 速率：100Mbps
  + 物理层标准：
    + 100BASE-TX：2对Cat.5 或 2对1类STP，一对发送一对接受，所以为全双工系统；最远100m；编码：4B/5B
    + 100BASE-FX：两芯多模/单模光纤；全双工；最远2km；编码：4B/5B
    + 100BASE-T4：4对Cat.3，3数据传输+1冲突检测；最远100m；编码：8B/6T
+ 千兆以太网
  + 速率：1000Mbps，发送时间从100ms变为1ms
  + 物理层标准：编码：8B/10B
    + 1000BASE-T：Cat.5，UTP长度可达100m
    + 1000BASE-X
      + 1000BASE-CX：STP，25m；用于交换机之间
      + 1000BASE-LX：单模光纤，3000m
      + 1000BASE-SX：多模光纤，550m

#### 交换式以太网

使用交换机代替Hub：

+ 广播：如果MAC地址表中<u>无目标地址</u>，交换机向除了接收端口外的所有其他端口转发（泛洪）
+ 学习：MAC地址表
  + 动态：学习接收到的数据帧的源MAC地址，会老化
  + 静态：管理员手动输入MAC地址，会一直存在
+ 转发：如果MAC地址表中<u>有目标地址</u>，根据地址表，单播转发数据帧
+ 更新：
  + 当一个帧的入端口，和MAC地址表中对应端口不同，则更新
  + 当一个MAC地址超过300s未使用，则老化（删除该记录）

转发方式：

+ 直接转发：只接收帧并检测目的地址，一边检测一边发送
  + 优点：交换时延低
  + 缺点：缺乏差错检验，接口间速率需要一致
+ 存储转发：完全接收帧后，进行校验，再转发
+ 无碎片转发（碎片丢弃）：接收到前64B后，判断头字段是否正确，不满64B的碎片将被丢弃

### 虚拟局域网-VLAN

需要在一个大的局域网中（一整个广播域），划分出几个小广播域

#### 静态VLAN

使用路由器，基于接口物理形成广播域：不方便！

#### 动态VLAN

配置交换机中的规则，使其可以区分不同的VLAN

+ 基于MAC地址：配置 MAC 到 VLAN 的从属关系表
+ 基于网络协议
+ 基于策略划分：
  + MAC + IP
  + MAC + IP + 接口 

可用的VLAN号： 0~4095号（12bit），其中头尾保留，故总 **4094个** VLAN号

#### 以太网端口类型

交换机上的接口：

+ Access端口：主要用于连接终端（PC机），特点是只允许一个VLAN的帧通过
  + 接收时（从终端到交换机）：
    + 没有VLAN标记，则添加VLAN标记（PVID）后转发
    + 有VLAN标记，丢弃
  + 发送时（到终端）：去掉VLAN标记发送，终端接收到的帧都是不带VLAN标记的
+ Trunk端口：主要用于连接其他交换机端口
  + 缺省VLAN时，不用带标签；其他VLAN，需要带标签通过
  + 发送报文时，对比VLAN标记与接口PVID：
    + 相同：去掉VLAN标记发送
    + 不同：直接发送
+ Hybrid端口：前两者的结合，任意VLAN的帧可以通过，通过配置决定带不带标签

#### VLAN中继协议：VTP协议（思科）

VTP协议：从一个**控制点**，维护整个VTP域中的VLAN添加、删除和重命名。通过Trunk链路广播传送VTP通告

+ 服务器模式：
  + 可以编辑：添加、删除和重命名VLAN
  + 可以更新：更新别的服务器模式交换机的配置
    + 通过**配置修订号**表示VTP信息的修改和同步
  + 可以转发：转发配置到其他交换机
+ 客户机模式：只可以更新与转发
+ 透明模式：只转发，维护自己的VLAN，对其他交换机而言为透明的

VTP修剪：

+ 概述：只有交换机创建并宣告了含有某个VLAN的接口，其他交换机才会向其转发该VLAN的广播
+ 原因：减少Trun链路的使用，正常情况下，广播会通过Trunk链路，到交换机处才丢弃；这样浪费了带宽

#### VLAN注册协议：GARP协议

GARP协议 是 GARP 的一种应用

##### 接口注册模式

+ Normal模式（默认，常用）：动态注册、注销；传播动态（学习其他交换机而来）、静态（手动输入）注册信息
+ Fixed模式：禁止~~动态注册、注销~~；只可以传播静态注册信息
+ Forbidden模式：禁止~~动态注册、注销~~；只允许通过VLAN-1

#### 生成树协议-STP

+ STP（生成树协议）：IEEE802.1D

+ RSTP（快速生成树协议）：IEEE802.1W

> 原因：为了备份使用冗余，导致形成物理环路，导致广播风暴、MAC表震荡（频繁更新）
>
> 原理：逻辑上断开环路，物理上不断开

STP形成无环拓朴的步骤：

> 选择根网桥 > 选择根接口 > 选择指定接口，总称为**收敛**过程

+ 选择根网桥（交换机）
  + 根据网桥ID，**最小的为根网桥**
  + ID构成：2B 优先级 + 6B MAC地址
    + 取值范围 0~65,536，缺省值为32,768，优先级为4096的倍数
+ 选择根端口：**非根网桥**上，选择一个到根网桥最近的端口作为根端口：优先级从高到低：
  + **路径成本**最低（带宽越大，成本越小）
  + **直连的网桥ID**最小
  + **直连端口ID**最小
+ 选择指定端口：
  + 根桥上的端口**都是指定端口**
  + 非根桥上的指定端口：
    + 本端口所在网桥到根网桥，**路径成本**最低
    + 本端口所在的**网桥ID值**较小
    + 本端口**ID值**较小 

#### 接口状态

STP接口中的状态包括：

+ 阻塞状态
+ 监听状态
+ 学习状态
  + 学习状态结束后：1. 根端口与指定端口进入**转发状态**；2. 其他接口进入**阻塞状态**
+ 转发状态

> 整个过程称为**收敛**，需要**50s**的时间，称为收敛时间

#### 快速生成树协议-RSTP

协议：IEEE802.1D标准 > IEEE802.1W标准

+ 端口角色（新增）：根端口、指定端口、<u>边缘端口、替代端口、备份端口</u>
+ 端口状态（简化）：丢弃、学习、转发

### 链路聚合

定义：交换机上的**多条物理线路**捆绑成为一个组，相当于**一条逻辑线路**

应用：可以形成以太网通道

操作：

+ 管理员静态设置
+ LACP（链路聚合控制协议）

### 无线局域网

#### 标准

**主要标准**：IEEEE 802.11

IEEEE 802.11标准，工作在2.4GHz时，共定义14个**信道**，常用**1、6、11**组合

#### 工作模式

+ 基础设施网络模式（Infrastructure）
  + 具有无线接入点（AP）接入骨干网，家庭常见如无线路由器（无线交换机）
+ 无访问点模式（Ad Hoc）
  + 无基础AP，仅为设备间互相通信

#### 通信技术

+ 红外线：定向光束红外线（点对点链路）、全向广播红外线和漫反射红外线
+ 扩展频谱：频率跳动扩展频谱（FHSS）和直接序列扩展频谱（DSSS）
+ 窄带微波：微波无线电频带（RF）

#### CSMA/CA 协议

因为存在<u>暴露站</u>和<u>隐蔽站</u>，不使用 [CSMA/CD 协议](###以太网技术 - CSMA/CD 协议)

#### 安全

**验证**：MAC验证、802.1x验证、PSK验证、Portal验证

**加密**：安全性：WEP < WPA < WPA2

### 综合布线系统

子系统分类：

1. 工作区子系统：网线端口到终端的部分
2. 水平子系统：连接 1 和 3的部分，如配线架
3. 管理子系统：每个楼层的接入层
4. 干线子系统（垂直子系统）：连接各个楼层的 3，以及 5 
5. 设备间子系统： 机房
6. 建筑群子系统（户外子系统）：楼与楼之间的连接

## 第八章  广域网与接入网技术

广域网（WAN）又称远程网，覆盖的范围为几十到几千千米

### 广域网交换方式

+ 专线
+ 交换：
  + 电路交换
  + 报文交换
  + 分组交换：
    + 虚电路：面向连接，可靠性强
    + 数据包：不可靠，应用在因特网
    + 信源：面向连接，以虚电路为基础；以信源为单位，长度固定为53字节（5B头部+48B数据部分）；应用在AMT机

### 流量与差错控制

协调发送站与接收站的工作步调

协议： 

+ 停等协议
+ 滑动窗口协议
+ 停等ARQ协议
+ 选择重发ARQ协议：一次发出最大帧数为 W <= 2^(k-1)，k为帧编号比特数；即**不大于帧编号总数的一半**
+ 后退N帧ARQ协议 ：一次发出最大帧数为 W <= 2^k - 1，即**不大于帧编号总数 - 1**

### 广域网链路层协议

#### HDLC协议

面向比特的链路层协议；是思科<u>默认</u>的<u>私有</u>协议；HDLC帧结构：

| 起始标志 | 地址数据 | 控制数据 | 信息数据（从网络层传来） | 帧校验序列 | 结束标志 |
| -------- | -------- | -------- | ------------------------ | ---------- | -------- |
| 01111110 | 8bit     | 8bit     | 8bit * n                 | 16/32bit   | 01111110 |

**注意**：为避免信息数据中，出现起始标识（01111110），使用<u>0比特填充技术</u>：

+ 发送前（未增加标志前）：遇到5个1，立即补上 0
+ 接收后（已去除标志后）：遇到5个1，立即删除之后的 0

### PPP协议

点对点链路上传输、封装网络层数据包的数据链路层协议。

PPP协议包括：

+ 建立配置链路阶段：链路控制协议（LCP）
+  验证阶段：
  + PAP验证：两次握手，明文传递，单次认证；花销小安全性低
  + CHAP验证：三次握手，哈希处理，可多次认证
+ NCP阶段：配置NCP，协商彼此的网络层协议；达成上层协议协商、验证

### 广域网传输标准

SONET/SDH系列，需要记忆信号表示与速率（P103）

### 接入网技术

#### xDSL

各种DSL数字用户线的总称，x表示任意字符，表示不同的调制方式，会使得：1. 获得的信号传输速率和距离不同；2. 上下行信道的对称性不同

介质：电话线（双绞铜线）gb

技术：频分复用技术

##### ADSL

5km，一对双绞铜线提供最高速率：上行1Mbps，下行8Mbps，非对称

> 对称性：上下行速率相同

##### 其他DSL

+ 对称
  + HDSL：1.544Mbps，2.048Mbps
  + SDSL：2.3Mbps

+ 非对称
  + VDSL：下行55Mbps，上行19.2Mbps（最快）
  + RADSL：下行8Mbps，上行1Mbps

#### HFL 

改造CATV（有线电视）：

+ 干线部分：使用光缆代替同轴电缆
+ 用户分配网络（支线）：保留电缆，但放大器改为双向

速率：下行30Mbps，上行10Mbps

#### FTTx

光纤接入技术

> 无源：服务商和客户之间的电子组件，**不需要电源**

##### 分类

+ 光纤接入网（OAN）
  + 有源光网络（AON）
  + 无源光网络（PON）组成：
    + 光线路终端（OLT）
    + <u>光分配网络（ODN）</u>：无源指该部分无需电源
    + 光网络单元（ONU）

##### 上下行方式

下行使用广播，上行使用TDMA时分多址

##### PON分类

+ EPON：1.25Gbps对称速率，以太网与PON的结合
+ GPON：下行2.5Gbps，上行1.244Gbps；对多种业务进行了封装

## 第九章 网络互联技术

该章节介绍了网际间的通信。

### 网际协议

互联网采用TCP/IP协议族，IP为互联网协议，为核心协议；该协议连入互联网的主机/路由器，分配一个**唯一的32位**标识符，称为**IP地址**，我们常常用每八位转化为一个十进制数，并在数字间加入点，称为点分十进制记法。

IP的编址方法经历了三个阶段：

1. IP地址分类
2. 子网划分
3. 无分类编址（CIDR）

#### IP地址分类

分为两个字段，分别为<u>网络号与主机号</u>

+ 网络号，决定可分配的网络总数：2^n（n为网络号位数） 
+ 主机号，决定每个网络可分配的主机数：2^m-2（m为主机号位数）；缺少的两种为：
  + 全为0：网络地址
  + 全为1：广播地址

按照网络规模的大小 ，定义了A~E类IP地址：

| 类别 | 8     | 16         | 24         | 32         | 范围    |
| ---- | ----- | ---------- | ---------- | ---------- | ------- |
| A    | 0~    | **主机号** | **主机号** | **主机号** | 1~126   |
| B    | 10~   | 网络号     | **主机号** | **主机号** | 128~191 |
| C    | 110~  | 网络号     | 网络号     | **主机号** | 192~223 |
| D    | 1110~ | 组播地址   | 组播地址   | 组播地址   | 224~239 |
| E    | 1111~ | 保留地址   | 保留地址   | 保留地址   | 240~255 |

##### 特殊IP地址

###### 网络地址

即是网络号，包括一个<u>有效的网络号</u>和<u>全`0`的主机号</u>

###### 广播地址

+ 有限广播地址：全为`1`；出现在目的地址时，路由器不会转发该数据包
+ 直接广播地址：除了上面，主机号全为`1`的地址；出现在目的地址时，发送给所有该网络主机

###### 私有地址

公有和私有：

+  公有地址：可以直接访问互联网的地址

+ 私有地址：分配给组织机构，该范围内的地址供内部使用；范围如下：

  | 类别 | IP地址范围                    | 网络号                  | 网络数 |
  | ---- | ----------------------------- | ----------------------- | ------ |
  | A    | 10.0.0.0 ~ 10.255.255.255     | 10                      | 1      |
  | B    | 172.16.0.0 ~ 172.31.255.255   | 172.16 ~ 172.31         | 16     |
  | C    | 192.168.0.0 ~ 192.168.255.255 | 192.168.0 ~ 192.168.255 | 256    |

###### 回送地址

网络号`127`开头的数据包，协议软件不进行任何传输，而**立即返回**；用于测试网络软件和本地机器进程的通信

###### 不确定地址

全为`0`的地址

+ 只能作为源地址临时使用，代表网络中的本主机
+ 出现在路由表里，表示任何网络，路由表无匹配时返回该条

#### IP分配与子网划分

在主机号借用数位作为**子网号**，将两级的IP地址变为三级：网络号、子网号与主机号

 **子网掩码**：网络号都为1，主机号都为0，和目的IP做“与”运算，得到相应的**子网网络号**（非主机号，为网络地址）

默认的子网掩码：A（255.0.0.0）、B（255.255.0.0）、C（255.255.255.0）

斜线表示法：192.168.1.1/24，表示网络号为24位

#### 无分类编址-CIDR

作用：汇总IP地址，将连续的地址空间块总结为一条路由条目

特点：

1. 不再有传统A、B、C类或子网划分；只分为两部分：“网络前缀”+主机标识：
   1. 使用斜线表示法
   2. 网络前缀相同的连续IP，组成一个CIDR地址块

##### 路由汇聚

可以缩小路由表的规模；

原理：上级路由器，将下级四个子网，汇聚为一个网络地址更短的超网路由，并只学习这个路由

##### 最长匹配原则

寻找目标路由有多个选择时，优先选择**最长网络前缀**的路由（意味着是更小范围的子网）

#### IPv4数据包

##### 组成

+ 首部
  + 固定部分：共**20字节**，所有数据包都有
  + 可变部分
+ 数据

##### 固定部分

1. 版本号（4位）
2. 首部长度（4位）：
   1. 表示首部长度共 *4n字节*（不满4字节则被填充）
   2. n的取值范围[5, 15]，所以长度取值为20~60字节；可变的部分实质为**13.IP选项**
3. 区分服务（8位）
4. 总长度（16位）：首部与数据的总和长度，单位字节
   1. 数据包最大长度为`2^16-1`=65535字节
   2. 如果数据包经过分片，则该值为分片后的大小

5. 标识（16位）：收到分片的数据包后，拥有相同标识的会被重装在一起
6. 标志（3位）：只用了2位
   1. 最低位（MF）：1-还有分片；0-最后一片
   2. 中间位（DF）：1-未分片；0-有分片
7. 分片偏移量（13位）：与原分组中的偏移量；单位为**8字节**，所以分片长度一定为8的整数倍

   1. 计算：分片后的第一位 于 <u>原分组中</u>的起始索引 / 8 = 分片偏移值
8. 生存时间（8位）：缩写为TTL，表明至多可经过多少个路由器，该值最大为255
   1. 原理：每次经过路由器**转发前**，将该值 -1；此时若为0，则被丢弃
   2. 设置为1时，表示该数据包只能于本局域网中流通
9. 协议（8位）：数据以什么高级协议建立
10. 首部校验和（16位）：只检验首部，不检验数据
11. 源IP（32位）
12. 目的IP（32位）

##### 可变部分

1. IP选项与填充：允许支持各种选项，有可能会导致首部不是4字节的整数倍，使用`0`补齐

2. 数据：封装上层协议的数据，如TCP、UDP；

   数据长度 = 4.总长度 - 2.首部长度，所以最长为 65535 - 20 = 65515字节

#### IPv6协议

+ 更大的地址空间：由八组由`:`分割的四位的十六进制数组成，转化为二进制为 8 * 4 * 4 = **128 位**
+ 灵活的首部格式：因此与IPv4协议不兼容
+ 支持自动配置、资源的预分配

##### 零压缩

+ 如果某组**四位都是零**，可以省略为`0:`或`:`
+ 如果省略出**多个相连的`:`**，则可以合并为一个，但只能压缩一处；还原时，填充`8 - 省略后组数 `组数的零
+ **前导零**可以省略：`0D88` > `D88`

##### 地址组成

1. 全球路由选择前缀，48位，0~47
2. 子网标识符，16位，48~63
3. 接口标识符，64位，64~127：主机号，可以转化为Mac地址

##### 地址类型

+ 单播地址：点对点

  + 可聚合全球地址：约等于公网
    + （全球路由选择前缀的）前三位固定为`001`

  + 本地地址
    + 链路本地地址：以`FE80`开头
    + 站点本地地址：以`FEC0`开头 


+ 组播地址/多播地址

  + 组播组的所有成员<u>全部</u>收到发向该组的数据包

  + 该地址不能作为源地址


+ 任播地址：IPv6特有

  + 标识一组网络接口

  + 数据包将会发送给距离本路由器<u>最近的一个</u>网络接口（并非组内全部）


**特殊**：

+ 未指定地址：`::/128`，全为0，
  + 初始化主机时，源地址临时使用该地址
+ 环回地址：`::1`，最后一位为1
  + 将数据包换发回接口本身

##### 过渡方案

+ 双协议栈：使设备同时支持两种协议

+ 隧道技术：在IPv6报文前增加IPv4前缀

+ 网络地址转换技术：通过协议转换

### QOS

QOS，服务质量，用以解决网络延迟和阻塞问题的技术

原理：区分流量，重要流量优先转发

服务类型：

+ 尽力而为的服务模型：先进先出的转发，未使用QOS
+ 综合服务模型
  + 提前申请网络资源，各节点预留资源
  + 保证服务和负载控制服务
  + RSVP（资源预留协议）
  + 适合小范围的网络
+ 区分服务模型：
  + 不预留资源，通过多种方法指定报文分类，不同分类对应不同服务
  + MPLS：路由器中分类

### 其他网际协议

#### ARP协议

获得IP地址到MAC地址的映射

#### ICMP协议

网际控制报文协议，报告错误（但不解决）：

+ 差错报告报文
  + 终点不可达
  + 源点抑制：路由器阻塞时，会丢弃报文，给发送方发送该报文，使其降低发送速率
  + 时间超过：TTL值耗尽，如果需要重发，发送方需要增加TTL值
  + 参数问题
  + 改变路由
+ 询问报文：
  + 回送请求或回答
  + 时间戳请求或回答

 应用：

+ `ping`命令：测试连通性，应用了**询问报文**
+ `Traceroute/Tracert`命令：路由跟踪命令（Linux/Window），发送**时间超过**与**终点不可达**的报文

### 传输层协议

#### TCP与UDP

传输层协议，实现端到端的通信

UDP

+ 无连接
+ 尽最大努力交付
+ 面向报文
+ 首部开销小
+ 实时性高

TCP

+ 面向连接
+ 点对点，只有两个端点
+ 可靠
+ 全双工通信
+ 面向字节流

#### TCP报文格式

1. TCP首部（包头）：

   1. 固定部分，共20字节：
      1. 源端口：2字节
      2. 目的端口：2字节
      3. 序列号(SEQ)：4字节
      4. 确认号(ACKNUM)：4字节，希望下一个接收的报文段 <u>3-序列号</u>
      5. 数据偏移：即首部长度
      6. 保留：6位
      7. 控制位
         1. URG：紧急控制位，表示有紧急数据需要传送；由<u>10-紧急指针</u>指出需要传送的位置
         2. ACK：确认位，是否为响应报文，使 4-确认号 生效
         3. PSH：推送位，不等缓冲区满，直接发送
         4. RST：重启位，需要重新建立链接
         5. SYN：同步位，处于建立链接过程中
         6. FIN：终止位，需要断开链接
      8. 窗口值(WIN)：接收方（空闲的）接收窗口，用于流量控制
      9. 校验和：
      10. 紧急指针

   1. 可变部分：
      1. 选项：长度可变
         1. 填充

2. 数据部分：来自应用层的数据

#### TCP三次握手

TCP通过三次握手来建立连接：

1. 客户到服务器：SYN=1, SEQ=x
2. 服务器到客户：SYN=1, ACK=1, SEQ=y, ACKNUM=x+1
3. 客户到服务器：ACK=1, SEQ=x+1, ACKNUM=y+1

#### TCP流量控制

利用了<u>可变大小的滑动窗口</u>机制

#### 传输层接口

端口号的范围为0 ~ 65535，分为三类端口：

+ 熟知端口：0~1023 ，分配给特定的熟知协议应用使用
+ 登记端口：1024~49151，无熟知端口号的应用程序，需要登记防止重复
+ 客户端口：49152~65525，客户自己动态设置的端口 

根据端口号大小又分为三类：

+ 低位端口：小于1024；知名应用的默认端口
+ 1024：保留端口
+ 高位端口：大于1024；可以手动分配给指定协议

### 应用层协议

应用层为OSI模型的第七层，面向与应用程序的接口；

常见的网络服务有：DNS、FTP、Telnet、DHCP、电子邮件和WWW服务器；

#### 域名解析服务-DNS

<u>UDP承载，端口53</u>

将主机名（域名）转化为IP地址

##### 域名层次空间

域名由英文和标点组成，不区分大小写，层次从左到右升高

+ 根域名：`.`，通常可以省略

+ 顶级域名

  + 国家顶级域名

  + 通用顶级域名

  + 基础结构域名

+ 二级、三级、四级域名……

##### 域名服务器类型

对应域名的层次，域名服务器**按层次**也划分为若干：

+ 根域名服务器
+ 顶级域名服务器
+ 权限域名服务器

而按照工作性质分为：

+ 主域名服务器
+ 辅助域名服务器
+ 转发域名服务器
+ 缓存域名服务器

##### 解析过程

域名解析工具：

+ Host表：静态，优先级高
+ DNS系统

域名解析过程：

+ 本地解析：
  + 查找缓存
  + host表
  + 本地DNS域名服务器
    + 区域文件
    + 缓存
+ 迭代解析：从根域名服务器开始，不断告知下一级服务器所在；主机本身继续寻找（默认）
+ 递归过程：询问根域名服务器，服务器将查询工作交由下一级服务器，查询到了之后原样返回给主机；主机本身只询问一次

##### DNS的记录类型

| 资源记录            | 说明                                                         |
| ------------------- | ------------------------------------------------------------ |
| SOA（起始授权机构） | 该区域中的主域名服务器                                       |
| NS（域名服务器）    | 该区域内的域名服务器（主服务器和辅助服务器）                 |
| A（主机）           | 该区域内，域名到IP的映射                                     |
| PTR（指针）         | 该区域内，IP到域名的映射                                     |
| MX                  | 邮件交换器记录，邮件后缀到邮件服务器的域名；同时还有一条A记录，指出邮件域名到IP的映射 |
| CNAME               | 基于A记录的主机，作出一个别名                                |

#### 远程登录服务-telnet

<u>采用TCP，端口23</u>

通过NVT格式，在客户端控制服务器

#### 文件传输服务-FTP

提供客户端到服务器的文件上传与下载

建立两个TCP连接：先建立控制连接、再建立数据连接

服务器端口：

+ 主动模式下：控制进程-21；数据进程-20

+ 被动模式下：传输端口使用高位端口，双方协定

**匿名登录**：使用特殊的ID"**anonymous**"作为账号，自身的e-mail账号作为口令

> anonymous /əˈnɒnɪməs/ *adj.* 匿名的

#### 动态地址分配服务-DHCP

 承载于UDP的高层协议报文，采用<u>67（服务器端）与68（客户端）端口</u>

##### 分配通信

1. 客户端：广播发送 **DHCP Discover**数据包
   1. 没有收到回应则重发，等待时长为1、2、4、8、16s，四次重发都失联的话，客户端自主选取 168.254.0.0/16 网络中的某个IP；选取后，依然按5min/次继续广播
2. 服务端：选择首个空置IP，响应 **DHCP Offer**数据包
3. 客户端：收到响应后（多个则挑一个，一般为先到），广播发送 **DHCP Request**数据包，告知所有DHCP服务器，已接受某个地址；未被选上的IP地址将被释放
4. 服务器：广播返回 **DHCP Ack**，含有租约信息；对于有线网络，win平台默认租期为8天，华为路由器为1天；无线网络的默认租期为6~8小时
5. 客户端：接受租约后，如果自身发现地址冲突或其他原因不能使用，则发送 **DHCP Decline**数据包

##### 命令：

+ ipconfig/all：显示本机TCP/IP配置
+ ipconfig/release：客户端手工释放IP地址
+ ipconfig/renew：客户端手工向服务器刷新请求

> release*/*rɪˈliːs/ *v.*释放，放走

##### 中继服务

上述操作只能于同一网段中实现，如果跨网段则需要中继机

中继机可以将客户端所发送的广播，转换为下一个网段中，对DHCP服务器的单播报文

#### 电子邮件协议

+ SMTP：简单邮件传输协议，邮件发送，25接口
+ POP3：邮局协议3.0，邮件接收，110接口
+ IMAP：邮件访问协议，代替POP3的新协议，工作在143接口

## 第十章 网络管理技术

### Window 基本管理

#### IPconfig 命令

显示与网卡相关的TCP/IP配置参数

语法格式为：`IPconfig /<param>`或`IPconfig -<param>`；参数列表：

1. `/all`：网卡的完整配置中心
2. `/renew`：更新动态IP地址
3. `/release`：释放动态IP地址
4. `/flushdns`：清除DNS解析程序的缓存
5. `/displaydns`：显示DNS解析程序的缓存
6. `/?`：显示帮助信息

#### ping

测试连通性，获取对方的反馈，其中包含对方的IP地址和TTL值（由此计算经过路由器转发的次数）

语法格式为：`ping /<param> ip地址或域名`；参数列表

1. `/t`：持续ping，直到`Ctrl+C`终止
2. `/l`：设置请求报文的字节长度，默认为32字节
3. `/a`：ping的同时，解析目的主机名
4. `/n`：设置回显数据包的数量，默认为4
5. `/?`：显示帮助信息

#### arp

1. `/a`：显示ARP缓存表
2. `/s`：添加静态条目

#### tracert

> trace*/*treɪs*/*  *v.* 追踪

注意是 trace + rt (route)

显示去往目的地之间，每一跳的路由器地址；原理是使用ICMP报文

1. `/d`：不解析主机名，增加显示速度

#### netstat

显示协议统计信息和当前的TCP/IP网络连接，常用于查询接口状态

参数有：

1. `/n`：数字形式显示IP地址与接口号
2. `/r`：显示路由表，效果同`route print`
3. `/a`：显示所有连接和监听接口
4. `/e`：显示以太网的统计信息，可以与`-s`连用
5. `/s`：显示每个协议的统计信息
6. `/o`：显示与每个连接所属的进程ID

#### nslookup

查询DNS，域名与IP的映射互转，或DNS服务器故障排查

## Linux

多用户、多任务的操作系统

### 目录结构

+ /
+ /dev
+ /etc
+ /home
+ /root
+ /tmp
+ /var
+ 

### 网络配置命令

#### `ifconfig`

网卡相关命令

```bash
ifconfig	# 查看网卡信息
ifconfig eth0 down 	# 关闭网卡
ifconfig eth0 up	# 开启网卡
ifconfig eth0 192.165.0.1 netmask 255.255.255.0 # 指定网卡地址与掩码
```

### `route`

设置路由

```bash
route add default	# 设置默认路由
route add [-net 网段地址]/[-host 主机地址] netmask [掩码] [gw 网关地址]/[dev 接口]	# 添加静态路由
route del [-net 网段地址]/[-host 主机地址] netmask [掩码] [gw 网关地址]/[dev 接口]	# 删除静态路由
```

> 注意：window平台，不需要-net和gw这两处字段

### 其他

+ ping：测试连通性

+ traceroute：同`tracert`，注意区分

+ netstat：协议统计信息

+ SSH：远程登录

## 网络管理

对网络运行进行监测和控制

### 网络管理功能

+ 配置管理
+ 故障管理
+ 性能管理
+ 计费管理
+ 安全管理

### SNMP协议

网络管理系统包括四个部分：网络管理站、管理代理、**网络管理协议**和管理信息库，SNMP为一种广泛使用的管理协议

+ 网络管理站 > 管理代理：通过UDP，接口161接收request报文

+ 管理代理 > 网络管理站：接口162，接收trap报文

版本：

+ SNMPv1：简单，易于实现
+ SNMPv2：支持完全集中和分布式两种网络管理
+ SNMPv3：达到了<u>商用安全要求</u>

### 网络存储

#### RAID技术

廉价冗余磁盘阵列，可以将多个容量较小的小磁盘在逻辑上形成一个大磁盘

分为多个级别：

##### RAID0

多个磁盘交错存储；

利用率100%

##### RAID1

一份数据，一份镜像；

利用率50%

##### RAID3

要求三个或以上的磁盘；

一个磁盘做奇偶校验盘，存放校验数据，其余用来存储；

利用率 (N-1)/N

##### RAID5

要求三个或以上的磁盘；

校验数据分散地存储在每一个盘上；

利用率 (N-1)/N

##### RAID6

拥有两份校验数据，同样分散地存储在每一个盘上；

利用率 (N-2)/N

##### RAID1+0

两个一组的RAID0，再组成一组RAID1

##### RAID1+0

两个一组的RAID1，再组成一组RAID0

#### DAS

直连式存储，物理上直接与主机相连

优点：简单，成本低

缺点：不易扩展与管理

#### NAS

网络附加存储，带有瘦AP，拥有自己的文件系统

优点：成本低，扩展与兼容性高

缺点：占用带宽，只能实现文件级的交互

#### SAN

存储区域网络，根据信道的不同有：

+ FC SAN：使用光纤与光纤通道交换机
  + 优点：块级交互，不占用带宽，适用于高性能环境
  + 缺点：成本高，管理难度大
+ IP SAN：使用以太网相连，结合FC与NAS
  + 优点：成本、难度相比于FC更低，适用于非关键存储业务
  + 缺点：可靠性一般

## 第十一章 网络安全技术

### 网络安全概述

#### 网络安全要素

五个基本要素：

1. 机密性
2. 完整性
3. 可用性
4. 可控性
5. 可审查性

#### 网络安全威胁

+ 被动攻击：
  + 截获

+ 主动攻击：会影响连接双方的通信
  + 中断
  + 篡改
  + 伪造
  + 重放

#### 网络攻击与防护

##### DDoS攻击

拒绝服务攻击（DoS攻击） > 分布式拒绝服务攻击（DDoS攻击）

##### SQL注入攻击

提交一段数据库查询代码，根据程序返回获取某些数据

##### XSS攻击

向Web页面插入恶意JavaScript代码

##### ARP欺骗攻击

+ 仿冒用户、网关发送伪造的ARP报文
+ 发送大量地址不能解析的IP报文
+ 发送大量ARP报文

防御：使用`ARP -s`命令，静态绑定IP到MAC的映射

##### APT攻击

高级持续性威胁攻击

### 计算机病毒

病毒的命名规律：病毒前缀.病毒名.病毒后缀

前缀：

+ worm：蠕虫病毒
+ trojan：木马病毒
+ Hack：黑客程序
+ macro：宏病毒
+ script：脚本病毒
+ win32：系统病毒

### 加密技术

#### 对称加密

对称：<u>加密与解密密钥相同</u>

又称常规加密、传统加密：

+ 优点：对称加密速度快，可用于大数据的加密

+ 缺点：密钥管理难

常见对称加密：

1. DES算法：56位加密密钥
2. 3DES算法：三重加密，其中第1、3次使用同一56位密钥，第2次使用另一个56位密钥
3. IDEA算法：使用128位密钥
4. AES算法：可以使用128、192与256位密钥
5. RC5算法：

#### 密钥分配管理

分配对称密钥。常用的方式是设立**密钥分配中心（KDC）**，分配协议为Kerberos协议

#### 非对称加密

非对称，分为公钥和私钥：<u>使用公钥加密，使用私钥解密</u>

+ 优点：无须共享通用密钥，可用于数字签名的场景
+ 缺点：加密速度慢

常见非对称加密：

1. RSA 算法
2. ECC 算法
3. 背包加密算法
4. Rabin 算法
5. DH 算法

#### 加密方式

按照网络层次的不同，数据加密方式有：

+ 链路加密：数据链路层
  + 每条链路的加密是独立的，相邻节点具有相同的密钥
  + 加密的功能由通信子网提供
+ 节点加密：传输层
+ 端到端加密：传输层以上
  + 协议数据单元的**控制信息部分**不被加密
  + 适合互联网环境

### 数字签名

基于**非对称加密**，主要功能有：报文鉴别、不可否认、报文的完整性

#### 报文摘要

由于加密时间长，可只生成**报文摘要**进行验证，常见的摘要算法有：

+ MD5：产生128位的输出
+ SHA（安全散列算法）：产生160位的输出

摘要的特点：

+ 无论原始数据长短，输出长度固定
+ 唯一性：每份数据都会生成唯一的摘要
+ 不可逆性（单向性）：不可从摘要反推数据

### 数字证书 

由证书签发机关（CA）签发的，对公钥提供权威 认证

### 网络安全协议

### SSL协议

安全套接层协议，保证<u>访问Web服务器</u>的安全，默认端口号443

#### 功能

1. 服务器鉴定 
2. 加密会话
3. 客户鉴别（可选）

#### 子协议

1. 握手协议
2. 记录协议
3. 报警协议

### SET协议

对与支付有关的报文进行加密

涉及三方：客户，商家，银行；要求三方都有证书

### PCG协议

电子邮件安全软件包，提供电子邮件的安全性、发件人鉴别与报文完整性功能

### 网络安全设备

#### 网闸

称为GAP，依托安全隔离技术为内网提供保护

#### 防火墙

##### 基本功能

1. 访问控制
2. 内容控制
3. 全面日志功能
4. 集中管理
5. 自身的安全和可用性

##### 防火墙的区域划分

不同安全区域发生数据流动时，防火墙触发安全检查机制

分为四个区域：

1. Trust区域（85）：高信任区域，通常定义为用户所在区域
2. DMZ区域（50）：中信任区域，公共服务器所在区域
3. Untrust区域（5）：低信任区域，Internet 区域
4. Local（100）：防火墙本身处于的区域

注：华为防火墙中区域具有可修改的安全等级，从1~100可信程度依次增大，括号中为默认的等级

##### 防火墙工作模式

路由模式：提供内外部地址的互相转化，兼任路由器的功能

透明模式：不提供地址转化，所以要额外配置出口路由器

混合模式：结合前两者，可以部分配置地址

##### 防火墙类型

+ 包过滤防火墙
  + 工作于网络层，更高层不做检查
  + 优点：速度快
  + 缺点：无法检查数据包，需要打开高位端口；安全性低

+ 应用代理防火墙
  + 工作在应用层，在客户端请求有效后，代为向服务器发出请求
  + 优点：允许或拒绝特定应用或服务，还有数据流监控、过滤、记录与报告等功能；具有高速缓存功能；安全性高
  + 缺点：速度慢，需要上报到应用层

+ 状态检测防火墙
  + 动态地根据应用需求，自动生成或删除包过滤规则 
  + 对同一数据流的报文不会重复检查，提高转发效率

### 入侵检测IDS

入侵检测系统（IDS）与防火墙形成互补关系

工作原理：

1. 收集原始数据
2. 分析并检测入侵行为
3. 响应攻击

系统组成：

+ 事件产生器：抓取数据（网络）和读取日志（主机），进行预处理形成原始数据
+ 事件分析器：根据一定规则，将产生器发来的数据与数据库做对比，然后将匹配结果发送给响应单元
  + 即时检测：模式匹配、统计分析
  + 事后检测：完整性分析
+ 事件数据库：保存各种恶意事件与正常事件的特征
+ 响应单元：根据结果进行操作，包括：记录时间、告警、通过、与防火墙通信、进一步处理等

系统分类：

+ 根据数据源分类：
  + 基于主机（AIDS）
  + 基于网络（NIDS）
  + 混合
+ 根据检测方法分类：
  + 异常检测，基于行为的检测：白名单模式
  + 特征检测，基于知识的检测：黑名单模式

部署位置：挂载在Internet接入路由后的第一台交换机的镜像接口上

> 镜像接口：所有通过该交换机的流量都会备份一份，转发给该接口

### 入侵防御IPS

## 第十二章 网络规划与设计

网络系统从构思到淘汰的过程称为**网络生命周期**，一次周期包括：

1. 需求分析：明确客户需要的网络服务与网络性能
2. 通信规范分析：分析网络中信息流量的分布问题
3. 逻辑网络设计：根据需求文档和通信规范，实施资源分配和安全规划
4. 物理网络设计：将<u>逻辑网络设计</u>的内容，应用到物理空间
5. 实施阶段

### 逻辑网络设计

#### 网络结构的设计

+ 核心层：快速转发
  + 需要做冗余备份

+ 汇聚层：
  + 网络较简单时，可以不用此层
  + 网络较复杂时，流量汇聚，减少核心层所需的接口；流量过滤；路由汇总

+ 接入层：接入用户终端
  + 可以提供多种接入方式
  + 提供强大的接入功能
  + 不需要冗余
  + 可以提供接入认证，用户信息收集，费用计算

#### IP地址规划

基本原则：

1. 唯一性：保证地址不冲突
2. 连续性：让连续的地址设计为易于路由汇聚的形式
3. 扩展性： 需要留有余地
4. 实意性：保持特殊的规律，比如网关地址设为`192.168.1.1/24 `，

#### 网络冗余设计

允许与设置双重网络满足网络可用性，目标有：

1. 路径备用：存有备用路径，通常于主线路失效时才投入使用
2. 负载分担：路径备用的扩充。使用多个网络接口和路径来分流流量

## 第14章 Linux服务器配置

### DNS服务器配置

#### 配置文件存放路径

+ 服务器：
  + 配置文件：`/ect/named.conf`
  + 根域名服务器地址：`/var/named/named.ca `
+ 客户端：
  + 配置文件：`/ect/resolv.conf`
  + 配置解析顺序：`/ect/hosts.conf`

注：配置DNS，而非`hos`t表，配置地址对应表是`/ect/hosts`

#### 启动与关闭

启动、关闭与重启

`service named start/stop/restart`

### Samba服务器配置

提供不同操作系统之间的资源共享，包括<u>文件和打印机</u>

#### 存放路径

主要配置文件在`/etc/samba/smb.conf`

#### 配置文件

`smb.conf`文件有三个主要配置参数：

1. 全局参数字段（global）
2. 目录分享字段（homes）
3. 打印机共享字段（printers）

#### 启动关闭

```
service smb start|stop|restart
```

### FTP 服务器配置

使用较为安全的`vsftpd`服务器

#### 存放路径

##### `vsftpd.conf`

配置文件：`/ect/vsftp/vsftpd.conf`

##### `user_list`

控制用户访问：`ect/vsftpd/user_list`

需要在`vsftpd.conf`中配置模式：

+ 黑名单模式：`userlist_enable=YES`、`userlist_deny=YES`
+ 白名单模式：`userlist_enable=YES`、`userlist_deny=NO`

#### 启动关闭

```
service vsftpd start|stop|restart
```

### Apache 服务器配置

对WWW服务器软件，包括IIS（win）以及Apache（Linux）

#### 存放路径

配置文件：`/ect/httpd/conf/httpd.conf`

默认web根目录：`/var/www/html`

## 第15章 网络设备配置

### 操作系统

**华为网络设备**：VRP，常用有VRP5和VRT8

Cisco（思科）设备：IOS

### 配置方法

1. console方式：没有IP地址的设备，使用console线缆与PC口的com相连，通过超级终端使用命令行配置
2. telnet方式：有IP地址的网络设备，并且PC与网络相连
3. web方式：有IP地址，且内置web页面的网络设备

### 路由器

静态路由

#### 动态路由

邻居关系：

优先级：

度量值：开销值越大，度量值越小

##### 动态路由协议

+ 内部：RIP、OSPF
+ 外部：BGP

##### 优先级

华为路由协议的优先级（数值越小越优先）：

1. 直连路由：0
2. OSPF：10
3. IS-IS：15
4. 静态路由：60
5. RIP：100
6. BGP：255

#### 距离矢量路由协议

确定网络中的最优路径

代表协议：`RIP`属于应用层协议

工作原理：

1. 以30s为周期，使用<u>UDP 520接口</u>向邻居路由器发送报文（包含其的整个路由表）。邻居路由表在180s内未生成某个表项，则设置为失效，若240s内未生成某个表项，则删除
2. **跳数为唯一度量衡**
3. 跳数最大为15跳，以上视为不可达
4. 经过更新后，每个路由器都拥有完整路由表的过程，称为**收敛**

#### OSPF-链路状态路由协议

代表协议：`OSPF`协议（开放式最短路径优先）

与RIP的不同：

+ 不使用跳数，而使用带宽作为度量值
+ 使用SPF算法避免产生网络环路
+ 通过邻居关系维护路由，更新效率高，收敛速度快

##### 工作原理

1. 每个路由器生成LSA，发送LSU包（包含LSA）给其他路由器
2. 把收到的LSA收集，存放到LSDB（链路状态数据库）
3. 使用SPF算法生成最短路径树
4. 利用这棵树形成OSPF

分组类型

1. 问候hello分组
2. 数据库描述分组
3. 链路状态请求LSR分组
4. 链路状态更新LSU分组
5. 链路状态确认LSA分组

##### DR与BDR

选举出一个DR（指定路由器），所有路由器的LSA都发给DR，DR再发送给其他路由器；BDR为DR的备份
